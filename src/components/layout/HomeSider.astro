---
import { HomeSiderType, HomeSiderSegmentType } from '@constants/enum';
import { cn } from '@lib/utils';
import HomeInfo from './HomeInfo.astro';
import { TableOfContents } from './TableOfContents/index';
import HomeSiderSegmented from '@components/ui/segmented/HomeSiderSegmented';
import { SeriesPostList } from '@components/post/SeriesPostList';
import { SeriesNavigation } from '@components/post/SeriesNavigation';
import { ScrollProgress } from './ScrollProgress';
import { getSeriesPosts, getAdjacentSeriesPosts } from '@lib/content/posts';
import type { BlogPost } from 'types/blog';

interface Props {
  type?: HomeSiderType;
  className?: string;
  isDrawer?: boolean;
  post?: BlogPost;
}

const { type = HomeSiderType.HOME, className, isDrawer = false, post } = Astro.props;
const defaultSegmentType = type === HomeSiderType.POST ? HomeSiderSegmentType.DIRECTORY : HomeSiderSegmentType.INFO;

// 获取系列文章
const seriesPosts = post && type === HomeSiderType.POST ? await getSeriesPosts(post) : [];

// 获取上一篇和下一篇
const { prevPost, nextPost } =
  post && type === HomeSiderType.POST ? await getAdjacentSeriesPosts(post) : { prevPost: null, nextPost: null };
---

<div
  class={cn(
    'page-home-sider shadow-home-sider sticky top-0 self-start flex min-w-64 max-w-[16rem] flex-col tablet:hidden overflow-auto h-screen items-center px-4 pb-',
    type === HomeSiderType.HOME ? 'pt-18' : 'pt-4',
    className,
  )}
  {...!isDrawer && { 'transition:name': 'page-home-sider' }}
>
  {
    type === HomeSiderType.POST && (
      <HomeSiderSegmented
        client:load
        className="mb-5 flex w-full justify-between text-sm/6"
        itemClass="grow"
        defaultValue={defaultSegmentType}
        id="inner-home-sider"
      />
    )
  }

  <sider-content class="w-full flex-1 overflow-auto" data-type={type} data-default-type={defaultSegmentType}>
    <div slot="info" class="sider-slot" data-slot-type="info">
      <HomeInfo />
    </div>
    <div slot="directory" class="sider-slot" data-slot-type="directory">
      {type === HomeSiderType.POST && <TableOfContents client:load />}
    </div>
    <div slot="series" class="sider-slot" data-slot-type="series">
      {type === HomeSiderType.POST && <SeriesPostList client:load posts={seriesPosts} currentPostSlug={post?.slug} />}
    </div>
  </sider-content>

  <!-- 内联脚本：在 DOM 解析后立即隐藏不需要的内容，避免闪烁 -->
  <script is:inline data-astro-rerun>
    (function () {
      const container = document.querySelector('sider-content');
      if (!container) return;

      const defaultType = container.getAttribute('data-default-type') || 'info';
      const slots = container.querySelectorAll('.sider-slot');

      slots.forEach((slot) => {
        const slotType = slot.getAttribute('data-slot-type');
        if (slotType !== defaultType) {
          slot.classList.add('hidden');
        }
      });
    })();
  </script>

  {
    type === HomeSiderType.POST && (
      <SeriesNavigation client:load prevPost={prevPost} nextPost={nextPost} className="w-full px-2" />
    )
  }

  <ScrollProgress client:load className="mt-auto w-full rounded-full pt-4" />
</div>

<script>
  import { HomeSiderType, HomeSiderSegmentType } from '@constants/enum';
  import { homeSiderSegmentType } from '@store/app';

  // 定义SiderContent自定义元素
  class SiderContent extends HTMLElement {
    // 私有属性定义
    private infoContent: HTMLElement | null = null;
    private directoryContent: HTMLElement | null = null;
    private seriesContent: HTMLElement | null = null;
    private pageType: string | null = null;
    private defaultType: string | null = null;

    constructor() {
      super();

      // 保存最初的内容片段
      this.infoContent = this.querySelector('[slot="info"]');
      this.directoryContent = this.querySelector('[slot="directory"]');
      this.seriesContent = this.querySelector('[slot="series"]');

      // 从HTML属性中获取当前页面类型和默认分段类型
      this.pageType = this.getAttribute('data-type');
      this.defaultType = this.getAttribute('data-default-type');

      // 初始化
      this.init();
    }

    init() {
      // 确保DOM已准备好
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => this.initContent());
      } else {
        this.initContent();
      }
    }

    initContent() {
      // 首页直接显示HomeInfo（无动画）
      if (this.pageType === HomeSiderType.HOME) {
        this.showContent(HomeSiderSegmentType.INFO, true);
      } else {
        // 设置初始值（无动画）
        const initialType = (this.defaultType as HomeSiderSegmentType) || HomeSiderSegmentType.INFO;
        homeSiderSegmentType.set(initialType);
        this.showContent(initialType, true);

        // 监听状态变化（有动画）
        homeSiderSegmentType.listen((value) => {
          this.showContent(value, false);
        });
      }
    }

    showContent(type: HomeSiderSegmentType, skipAnimation = false) {
      // 确定目标内容
      let targetContent: HTMLElement | null = null;
      if (type === HomeSiderSegmentType.DIRECTORY) {
        targetContent = this.directoryContent;
      } else if (type === HomeSiderSegmentType.SERIES) {
        targetContent = this.seriesContent;
      } else {
        targetContent = this.infoContent;
      }

      // 如果是初始化或者跳过动画，直接切换
      if (skipAnimation) {
        // 先隐藏所有
        [this.infoContent, this.directoryContent, this.seriesContent].forEach((content) => {
          content?.classList.add('hidden');
        });
        // 再显示目标
        targetContent?.classList.remove('hidden');
        return;
      }

      // 如果已经在显示目标内容，直接返回
      if (targetContent && !targetContent.classList.contains('hidden')) {
        return;
      }

      // 隐藏其他内容（添加退出动画）
      [this.infoContent, this.directoryContent, this.seriesContent].forEach((content) => {
        if (content && content !== targetContent && !content.classList.contains('hidden')) {
          content.classList.add('exiting');
          setTimeout(() => {
            content.classList.add('hidden');
            content.classList.remove('exiting');
          }, 200);
        }
      });

      // 显示目标内容（添加进入动画）
      if (targetContent) {
        targetContent.classList.remove('hidden');
        requestAnimationFrame(() => {
          targetContent?.classList.add('entering');
          setTimeout(() => {
            targetContent?.classList.remove('entering');
          }, 200);
        });
      }
    }
  }

  // 注册自定义元素
  customElements.define('sider-content', SiderContent);
</script>

<style>
  sider-content {
    position: relative;
  }

  .sider-slot {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
  }

  .sider-slot.hidden {
    display: none;
  }

  /* 默认无动画，适用于 prefers-reduced-motion: reduce */
  .sider-slot.entering,
  .sider-slot.exiting {
    animation: none;
  }

  /* 只在用户未设置 reduce-motion 时应用动画 */
  @media (prefers-reduced-motion: no-preference) {
    .sider-slot.entering {
      animation: slide-in-from-right 0.2s ease-in-out;
    }

    .sider-slot.exiting {
      animation: slide-out-to-left 0.2s ease-in-out;
    }
  }
</style>
