---
import Search from 'astro-pagefind/components/Search';
import { Icon } from 'astro-icon/components';
---

<!-- Search trigger button -->
<button
  id="search-trigger"
  class="group cursor-pointer transition duration-300 hover:scale-125"
  aria-label="搜索"
  title="搜索 (⌘K)"
>
  <Icon name="ri:search-line" class="size-8" />
</button>

<!-- Search Component - will be portal'd into dialog -->
<div id="search-component-portal">
  <Search
    id="search-for-dialog"
    className="pagefind-ui"
    uiOptions={{
      showImages: false,
      resetStyles: false,
      // TODO i18n support
      translations: {
        placeholder: '请输入关键词搜索',
        clear_search: '清空',
        load_more: '加载更多结果',
        search_label: '搜索本站',
        filters_label: '过滤器',
        zero_results: '没有找到结果',
        many_results: '[COUNT] 个结果',
        one_result: '[COUNT] 个结果',
        alt_search: '没有找到结果。显示 [DIFFERENT_TERM] 的结果',
        search_suggestion: '没有找到结果。尝试以下搜索：',
        searching: '搜索 [SEARCH_TERM]...',
      },
    }}
  />
</div>

<script>
  import { openSearch } from '@store/ui';

  let triggerElement: HTMLElement | null = null;

  function handleTriggerClick() {
    openSearch();
  }

  function moveSearchToDialog() {
    const dialogContainer = document.getElementById('search-dialog-container');
    const searchPortal = document.getElementById('search-component-portal');
    const searchComponent = document.getElementById('search-for-dialog');

    if (!dialogContainer || !searchPortal || !searchComponent) return;

    // Check if search component is already in the dialog
    if (dialogContainer.contains(searchComponent)) return;

    // Move search component to dialog
    dialogContainer.appendChild(searchComponent);
  }

  function moveSearchBack() {
    const searchComponent = document.getElementById('search-for-dialog');
    const searchPortal = document.getElementById('search-component-portal');

    if (!searchComponent || !searchPortal) return;

    // Move search component back to portal if it's not already there
    if (!searchPortal.contains(searchComponent)) {
      searchPortal.appendChild(searchComponent);
    }
  }

  function handleDialogOpen() {
    // Small delay to ensure dialog container is rendered
    requestAnimationFrame(() => {
      moveSearchToDialog();
    });
  }

  function handleDialogClose() {
    // Move search back immediately before DOM is removed
    moveSearchBack();
  }

  let initialized = false;

  function initSearchDialog() {
    // Prevent double initialization
    if (initialized) return;
    initialized = true;

    // Init trigger button
    triggerElement = document.getElementById('search-trigger');
    triggerElement?.addEventListener('click', handleTriggerClick);
    // Listen for custom events from Astro component
    window.addEventListener('search-dialog-open', handleDialogOpen);
    window.addEventListener('search-dialog-close', handleDialogClose);
  }

  function cleanupSearchDialog() {
    if (!initialized) return;

    triggerElement?.removeEventListener('click', handleTriggerClick);
    triggerElement = null;
    window.removeEventListener('search-dialog-open', handleDialogOpen);
    window.removeEventListener('search-dialog-close', handleDialogClose);
    initialized = false;
  }

  // Initialize immediately if DOM is ready (handles race condition on first load)
  if (document.readyState !== 'loading') {
    initSearchDialog();
  }

  // Also listen for astro:page-load for subsequent navigations
  document.addEventListener('astro:page-load', initSearchDialog);
  document.addEventListener('astro:before-swap', cleanupSearchDialog);
</script>

<style>
  /* Hide the portal container */
  #search-component-portal {
    display: none;
    position: absolute;
    pointer-events: none;
    visibility: hidden;
  }
</style>
<style is:global is:inline>
  /* https://github.com/parcel-bundler/lightningcss/issues/887 */
  .scroll-feather-mask {
    container-type: scroll-state;
  }
  @container scroll-state(scrollable: bottom) {
    .scroll-feather-mask::before {
      content: '';
      background: linear-gradient(
        to bottom,
        transparent 0%,
        var(--gradient-bg-start) var(--scroll-mask-middle, 70%),
        var(--gradient-bg-start) var(--scroll-mask-end, 100%)
      );
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10;
      display: block;
      height: var(--scroll-mask-height, 5rem);
    }
  }
</style>
