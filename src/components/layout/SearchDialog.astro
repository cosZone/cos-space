---
import { Icon } from 'astro-icon/components';
---

<!-- 遮罩层 -->
<div
  id="search-overlay"
  data-state="closed"
  class="fixed inset-0 z-40 bg-black/50 opacity-0 backdrop-blur-sm transition-opacity duration-200 data-[state=closed]:hidden"
  role="presentation"
  aria-hidden="true"
>
</div>

<!-- 搜索对话框 -->
<div
  id="search-dialog"
  data-state="closed"
  class="fixed inset-0 z-50 grid place-items-center px-4 data-[state=closed]:hidden"
  role="dialog"
  aria-label="搜索文章"
  aria-modal="true"
>
  <div
    id="search-dialog-content"
    class="bg-gradient-start shadow-box w-full max-w-3xl overflow-auto rounded-xl opacity-0 transition-all duration-200"
  >
    <div class="relative p-6 md:p-3">
      <div class="search-dialog">
        <!-- Header -->
        <div class="relative mb-4 flex items-center justify-between">
          <h2 class="flex items-center gap-2 text-lg font-semibold md:text-base">
            <Icon name="ri:search-line" class="size-5 md:size-4" />
            搜索文章
          </h2>
          <button
            id="search-dialog-close"
            class="flex size-8 items-center justify-center rounded-full bg-black/5 transition-colors duration-300 hover:bg-black/10 md:size-7 dark:bg-white/10 dark:hover:bg-white/20"
            aria-label="关闭搜索"
          >
            <Icon name="ri:close-line" class="size-5 md:size-4" />
          </button>
        </div>
        <div
          id="search-empty-hint"
          class="search-empty-hint absolute inset-x-0 top-32 text-center text-sm opacity-60 md:top-28"
        >
          <p>输入关键词搜索博客文章</p>
          <p class="mt-1 text-xs">
            按 <kbd class="rounded bg-black/10 px-1.5 py-0.5 font-mono dark:bg-white/10">ESC</kbd> 关闭
          </p>
        </div>

        <!-- Search Content Area -->
        <div
          class="scroll-feather-mask -mx-6 -mb-6 h-[calc(80dvh-6rem)] overflow-auto scroll-smooth px-6 pb-6 md:-mx-3 md:px-3"
        >
          <!-- Search Container -->
          <div id="search-dialog-container"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import { searchOpen, openSearch, closeSearch } from '@store/ui';

  interface SearchDialogElements {
    overlay: HTMLElement | null;
    dialog: HTMLElement | null;
    content: HTMLElement | null;
    closeBtn: HTMLElement | null;
  }

  const SELECTORS = {
    overlay: 'search-overlay',
    dialog: 'search-dialog',
    content: 'search-dialog-content',
    closeBtn: 'search-dialog-close',
  } as const;

  const CLASSES = {
    opacityFull: 'opacity-100',
    opacityZero: 'opacity-0',
  } as const;

  const STATE = {
    open: 'open',
    closed: 'closed',
  } as const;

  class SearchDialogController {
    private elements: SearchDialogElements;
    private unsubscribe: (() => void) | null = null;

    constructor() {
      this.elements = this.initElements();
      if (this.validateElements()) {
        this.bindEvents();
        this.subscribeToStore();
      }
    }

    private initElements(): SearchDialogElements {
      return Object.entries(SELECTORS).reduce(
        (acc, [key, id]) => ({
          ...acc,
          [key]: document.getElementById(id),
        }),
        {} as SearchDialogElements,
      );
    }

    private validateElements(): boolean {
      return Object.entries(this.elements).every(([key, element]) => {
        const exists = !!element;
        if (!exists) {
          console.error(`搜索对话框元素未找到: ${key}`);
        }
        return exists;
      });
    }

    private bindEvents(): void {
      // Keyboard shortcuts
      document.addEventListener('keydown', this.handleKeyDown);
      // Close button
      this.elements.closeBtn?.addEventListener('click', this.handleClose);
      // Click dialog background (not content) to close
      this.elements.dialog?.addEventListener('click', this.handleBackgroundClick);
    }

    private handleBackgroundClick = (e: MouseEvent): void => {
      // Only close if clicking the dialog background, not the content
      if (e.target === this.elements.dialog) {
        closeSearch();
      }
    };

    private subscribeToStore(): void {
      this.unsubscribe = searchOpen.subscribe((isOpen) => {
        if (isOpen) {
          this.open();
        } else {
          this.close();
        }
      });
    }

    private handleKeyDown = (e: KeyboardEvent): void => {
      // Cmd/Ctrl + K to open
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openSearch();
      }
      // ESC to close
      if (e.key === 'Escape' && searchOpen.get()) {
        closeSearch();
      }
    };

    private handleClose = (): void => {
      closeSearch();
    };

    private open(): void {
      const { overlay, dialog, content } = this.elements;
      if (!overlay || !dialog || !content) return;

      // Show elements
      overlay.dataset.state = STATE.open;
      dialog.dataset.state = STATE.open;

      // Lock body scroll
      document.body.style.overflow = 'hidden';

      // Dispatch event for search component portal
      window.dispatchEvent(new CustomEvent('search-dialog-open'));

      // Trigger animation
      requestAnimationFrame(() => {
        overlay.classList.remove(CLASSES.opacityZero);
        overlay.classList.add(CLASSES.opacityFull);
        content.classList.remove(CLASSES.opacityZero);
        content.classList.add(CLASSES.opacityFull);
      });

      // Focus search input after animation
      setTimeout(() => {
        const searchInput = document.querySelector('.pagefind-ui__search-input') as HTMLInputElement;
        if (searchInput) {
          searchInput.focus();
        }
      }, 150);
    }

    private close(): void {
      const { overlay, dialog, content } = this.elements;
      if (!overlay || !dialog || !content) return;

      // Dispatch event before closing
      window.dispatchEvent(new CustomEvent('search-dialog-close'));

      // Trigger close animation
      overlay.classList.remove(CLASSES.opacityFull);
      overlay.classList.add(CLASSES.opacityZero);
      content.classList.remove(CLASSES.opacityFull);
      content.classList.add(CLASSES.opacityZero);

      // Hide elements after animation
      setTimeout(() => {
        overlay.dataset.state = STATE.closed;
        dialog.dataset.state = STATE.closed;
        document.body.style.overflow = '';
      }, 200);
    }

    public destroy(): void {
      document.removeEventListener('keydown', this.handleKeyDown);
      this.elements.closeBtn?.removeEventListener('click', this.handleClose);
      this.elements.dialog?.removeEventListener('click', this.handleBackgroundClick);

      if (this.unsubscribe) {
        this.unsubscribe();
        this.unsubscribe = null;
      }
    }
  }

  let controller: SearchDialogController | null = null;

  function init() {
    controller?.destroy();
    controller = new SearchDialogController();
  }

  // Initialize immediately if DOM is ready (handles race condition on first load)
  if (document.readyState !== 'loading') {
    init();
  }

  // Also listen for astro:page-load for subsequent navigations
  document.addEventListener('astro:page-load', init);

  // Close before page navigation
  document.addEventListener('astro:before-preparation', () => {
    closeSearch();
  });
</script>

<style is:global>
  /* Hide empty hint when search has results or is loading */
  #search-dialog-container:has(.pagefind-ui__results) ~ #search-empty-hint,
  #search-dialog-container:has(.pagefind-ui__message) ~ #search-empty-hint {
    display: none;
  }
</style>
