---
declare global {
  interface Window {
    remark_config: {
      host: string;
      site_id: string;
      components: string[];
      max_shown_comments: number;
      theme: string;
      locale: string;
      show_email_subscription: boolean;
      simple_view: boolean;
    };
    REMARK42: {
      createInstance: (config: {
        node: HTMLElement;
        host: string;
        site_id: string;
        max_shown_comments: number;
        theme: string;
        locale: string;
        show_email_subscription: boolean;
        simple_view: boolean;
      }) => Remark42Instance;
      ready: boolean;
      changeTheme?: (theme: 'light' | 'dark') => void;
    };
  }

  // Type for Remark42 instance
  interface Remark42Instance {
    destroy: () => void;
  }
}

export interface Props {
  noMarginTop?: boolean;
}
---

<div class="comments" class="mx-auto w-full px-4 pb-12">
  <p class="text-muted-foreground text-center text-sm">先使用 Remark42 作为临时评论系统，样式等有待优化</p>
  <div id="remark42" class="mx-auto"></div>
</div>

<script>
  // Type for Remark42 instance
  interface Remark42Instance {
    destroy: () => void;
  }

  let remark42Instance: Remark42Instance | null = null;
  // Configuration for Remark42
  window.remark_config = {
    host: 'https://comment.cosine.ren',
    site_id: 'cos-space',
    components: ['embed', 'counter'],
    max_shown_comments: 100,
    theme: localStorage.getItem('theme') || 'light',
    locale: 'en',
    show_email_subscription: false,
    simple_view: true,
  };

  // Initialize Remark42 instance
  function initRemark42() {
    if (window.REMARK42) {
      // Destroy previous instance if exists
      if (remark42Instance) {
        remark42Instance.destroy();
      }

      // Create new instance
      const node = document.getElementById('remark42');
      if (node) {
        remark42Instance = window.REMARK42.createInstance({
          node,
          host: window.remark_config.host,
          site_id: window.remark_config.site_id,
          max_shown_comments: window.remark_config.max_shown_comments,
          theme: window.remark_config.theme,
          locale: window.remark_config.locale,
          show_email_subscription: window.remark_config.show_email_subscription,
          simple_view: window.remark_config.simple_view,
        });
      }
    }
  }

  // Load Remark42 scripts
  (function (components, doc) {
    for (let i = 0; i < components.length; i++) {
      const script = doc.createElement('script') as HTMLScriptElement;
      const extension = 'noModule' in script ? '.mjs' : '.js';

      if ('noModule' in script) {
        script.type = 'module';
      } else {
        (script as HTMLScriptElement).async = true;
        (script as HTMLScriptElement).defer = true;
      }

      script.src = `${window.remark_config.host}/web/${components[i]}${extension}`;
      (doc.head || doc.body).appendChild(script);
    }
  })(window.remark_config.components || ['embed'], document);

  // Initialize when Remark42 is ready or wait for it to be ready
  document.addEventListener('DOMContentLoaded', () => {
    if (window.REMARK42) {
      initRemark42();
    } else {
      window.addEventListener('REMARK42::ready', () => {
        initRemark42();
      });
    }
  });

  // Handle Astro page transitions
  document.addEventListener('astro:page-load', () => {
    initRemark42();
  });

  // Clean up before page transitions
  document.addEventListener('astro:before-swap', () => {
    if (remark42Instance) {
      remark42Instance.destroy();
    }
  });

  // Theme synchronization: Watch for theme changes and update Remark42
  function setupThemeSync() {
    let themeChangeTimeout: ReturnType<typeof setTimeout> | null = null;

    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          // Clear previous timeout to debounce rapid changes
          if (themeChangeTimeout) {
            clearTimeout(themeChangeTimeout);
          }

          // Wait for theme transition animation to complete before updating Remark42
          // This prevents flickering during the view transition animation
          themeChangeTimeout = setTimeout(() => {
            const isDark = document.documentElement.classList.contains('dark');
            const newTheme = isDark ? 'dark' : 'light';

            // Update Remark42 theme if the changeTheme method is available
            if (window.REMARK42?.changeTheme) {
              window.REMARK42.changeTheme(newTheme);
            }
          }, 50); // Wait 50ms for the theme transition animation to complete
        }
      });
    });

    // Observe class changes on documentElement
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class'],
    });
  }

  // Set up theme synchronization after Remark42 is loaded
  document.addEventListener('DOMContentLoaded', () => {
    if (window.REMARK42) {
      setupThemeSync();
    } else {
      window.addEventListener('REMARK42::ready', () => {
        setupThemeSync();
      });
    }
  });

  // Re-setup theme sync on page transitions
  document.addEventListener('astro:page-load', () => {
    setupThemeSync();
  });
</script>
