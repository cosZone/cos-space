---
import type { ContentConfig } from '@constants/content-config';
import type { AstroComponentFactory } from 'astro/runtime/server/index.js';
import { defaultContentConfig } from '@constants/content-config';
import CodeBlockFullscreen from '@components/markdown/CodeBlockFullscreen';

interface Props {
  Content: AstroComponentFactory;
  config?: Partial<ContentConfig>;
}

const { Content, config = {} } = Astro.props;
const finalConfig = { ...defaultContentConfig, ...config };
---

<div class="custom-content" data-config={JSON.stringify(finalConfig)}>
  <Content />
</div>

<!-- Code block fullscreen dialog -->
<CodeBlockFullscreen client:only="react" />

<script>
  import type { ContentConfig } from '@constants/content-config';
  import { enhanceAllCodeBlocks } from '@lib/code-block-enhancer';

  // Custom content enhancement script
  function enhanceContent() {
    const contentContainer = document.querySelector('.custom-content');
    if (!contentContainer) return;

    // Avoid re-enhancing
    if (contentContainer.getAttribute('data-enhanced') === 'true') return;

    // Get configuration from data attribute
    const configData = contentContainer.getAttribute('data-config');
    const config: ContentConfig = configData
      ? JSON.parse(configData)
      : {
          addBlankTarget: true,
          smoothScroll: true,
          addHeadingLevel: true,
          enhanceCodeBlock: true,
          enableCodeCopy: true,
          enableCodeFullscreen: true,
        };

    // Add target="_blank" to external links
    if (config.addBlankTarget) {
      const links = contentContainer.querySelectorAll('a[href]');
      links.forEach((link: Element) => {
        const anchor = link as HTMLAnchorElement;
        const href = anchor.getAttribute('href') || '';

        // Check if it's an external link (starts with http/https or is absolute)
        if (href.startsWith('http') || href.startsWith('//')) {
          anchor.setAttribute('target', '_blank');
        }
      });
    }

    // Add smooth scroll to anchor links
    if (config.smoothScroll) {
      const anchorLinks = contentContainer.querySelectorAll('a.anchor-link[href^="#"]');
      anchorLinks.forEach((link: Element) => {
        const anchor = link as HTMLAnchorElement;

        anchor.addEventListener('click', (e) => {
          e.preventDefault();

          const targetId = anchor.getAttribute('href')?.substring(1);
          if (!targetId) return;

          const targetElement = document.getElementById(targetId);
          if (targetElement) {
            targetElement.scrollIntoView({
              behavior: 'smooth',
              block: 'start',
            });

            // Update URL hash without jumping
            history.pushState(null, '', `#${targetId}`);
          }
        });
      });
    }

    // Add heading level labels (H1, H2, etc.)
    if (config.addHeadingLevel) {
      const headings = contentContainer.querySelectorAll('h1, h2, h3, h4, h5, h6');
      headings.forEach((heading: Element) => {
        const level = heading.tagName[1]; // Extract number from H1, H2, etc.
        heading.setAttribute('data-level', `H${level}`);
      });
    }

    // Enhance code blocks with Mac window style
    if (config.enhanceCodeBlock) {
      enhanceAllCodeBlocks(contentContainer, {
        enableCopy: config.enableCodeCopy,
        enableFullscreen: config.enableCodeFullscreen,
        onFullscreen: (info) => {
          // Dispatch custom event for React component to handle
          window.dispatchEvent(
            new CustomEvent('open-code-fullscreen', {
              detail: {
                code: info.code,
                codeHTML: info.codeHTML,
                language: info.language,
                preClassName: info.preClassName,
                preStyle: info.preStyle,
                codeClassName: info.codeClassName,
              },
            }),
          );
        },
      });
    }

    // Mark as enhanced
    contentContainer.setAttribute('data-enhanced', 'true');
  }

  // Run on page load
  document.addEventListener('astro:page-load', () => {
    // Reset enhanced state on page change
    const contentContainer = document.querySelector('.custom-content');
    if (contentContainer) {
      contentContainer.removeAttribute('data-enhanced');
    }
    enhanceContent();
  });

  // Run immediately if already loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', enhanceContent);
  } else {
    enhanceContent();
  }
</script>
