---
import { Icon } from 'astro-icon/components';
---

<!-- 遮罩层 -->
<div
  id="code-fullscreen-overlay"
  data-state="closed"
  class="fixed inset-0 z-40 bg-black/80 opacity-0 backdrop-blur-sm transition-opacity duration-200 data-[state=closed]:hidden"
  role="presentation"
  aria-hidden="true"
>
</div>

<!-- 代码全屏对话框 -->
<div
  id="code-fullscreen-dialog"
  data-state="closed"
  class="fixed inset-0 z-50 grid place-items-center px-4 data-[state=closed]:hidden"
  role="dialog"
  aria-label="代码全屏预览"
  aria-modal="true"
>
  <div
    id="code-fullscreen-content"
    class="bg-background relative flex h-[85vh] w-[90vw] max-w-6xl flex-col overflow-hidden rounded-xl opacity-0 shadow-2xl transition-opacity duration-200 md:max-w-[90vw]"
  >
    <!-- Toolbar -->
    <div class="border-border bg-muted/50 flex shrink-0 items-center justify-between border-b px-4 py-3 backdrop-blur-sm">
      <div class="flex items-center gap-3">
        <div class="flex gap-2">
          <span class="h-3 w-3 rounded-full bg-[#ff5f56]"></span>
          <span class="h-3 w-3 rounded-full bg-[#ffbd2e]"></span>
          <span class="h-3 w-3 rounded-full bg-[#27c93f]"></span>
        </div>
        <span
          id="code-fullscreen-language"
          class="text-muted-foreground font-mono text-xs font-medium tracking-wider uppercase"
        >
          text
        </span>
      </div>
      <div class="flex items-center gap-1">
        <button
          id="code-fullscreen-copy"
          class="text-muted-foreground hover:bg-accent hover:text-accent-foreground flex items-center gap-2 rounded-md px-3 py-1.5 transition-colors"
        >
          <!-- Copy icon -->
          <svg
            id="code-fullscreen-copy-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 448 512"
            fill="currentColor"
          >
            <path
              d="M192 0c-35.3 0-64 28.7-64 64l0 256c0 35.3 28.7 64 64 64l192 0c35.3 0 64-28.7 64-64l0-200.6c0-17.4-7.1-34.1-19.7-46.2L370.6 17.8C358.7 6.4 342.8 0 326.3 0L192 0zM64 128c-35.3 0-64 28.7-64 64L0 448c0 35.3 28.7 64 64 64l192 0c35.3 0 64-28.7 64-64l0-16-64 0 0 16-192 0 0-256 16 0 0-64-16 0z"
            ></path>
          </svg>
          <!-- Checkmark icon (hidden by default) -->
          <svg
            id="code-fullscreen-check-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            class="hidden"
          >
            <mask id="checkmark-anim-fullscreen">
              <g
                fill="none"
                stroke="#fff"
                stroke-dasharray="24"
                stroke-dashoffset="24"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
              >
                <path d="M2 13.5l4 4l10.75 -10.75">
                  <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.4s" values="24;0"></animate>
                </path>
                <path stroke="#000" stroke-width="6" d="M7.5 13.5l4 4l10.75 -10.75">
                  <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.4s" dur="0.4s" values="24;0"></animate>
                </path>
                <path d="M7.5 13.5l4 4l10.75 -10.75">
                  <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.4s" dur="0.4s" values="24;0"></animate>
                </path>
              </g>
            </mask>
            <rect width="24" height="24" fill="currentColor" mask="url(#checkmark-anim-fullscreen)"></rect>
          </svg>
          <span id="code-fullscreen-copy-text" class="text-sm">复制</span>
        </button>
        <button
          id="code-fullscreen-close"
          class="text-muted-foreground hover:bg-accent hover:text-accent-foreground rounded-md p-2 transition-colors"
          aria-label="关闭"
        >
          <Icon name="ri:close-line" class="h-5 w-5" />
        </button>
      </div>
    </div>

    <!-- Code Content -->
    <div class="scroll-feather-mask flex-1 overflow-auto">
      <pre id="code-fullscreen-pre" class="p-4"><code id="code-fullscreen-code" /></pre>
    </div>
  </div>
</div>

<script>
  import { codeFullscreenData, openCodeFullscreen, closeCodeFullscreen, type CodeBlockData } from '@store/ui';
  import { copyToClipboard } from '@lib/code-block-enhancer';

  interface CodeFullscreenElements {
    overlay: HTMLElement | null;
    dialog: HTMLElement | null;
    content: HTMLElement | null;
    closeBtn: HTMLElement | null;
    copyBtn: HTMLElement | null;
    copyIcon: HTMLElement | null;
    checkIcon: HTMLElement | null;
    copyText: HTMLElement | null;
    language: HTMLElement | null;
    pre: HTMLElement | null;
    code: HTMLElement | null;
  }

  const SELECTORS = {
    overlay: 'code-fullscreen-overlay',
    dialog: 'code-fullscreen-dialog',
    content: 'code-fullscreen-content',
    closeBtn: 'code-fullscreen-close',
    copyBtn: 'code-fullscreen-copy',
    copyIcon: 'code-fullscreen-copy-icon',
    checkIcon: 'code-fullscreen-check-icon',
    copyText: 'code-fullscreen-copy-text',
    language: 'code-fullscreen-language',
    pre: 'code-fullscreen-pre',
    code: 'code-fullscreen-code',
  } as const;

  const CLASSES = {
    opacityFull: 'opacity-100',
    opacityZero: 'opacity-0',
    copied: 'text-primary',
    hidden: 'hidden',
  } as const;

  const STATE = {
    open: 'open',
    closed: 'closed',
  } as const;

  /**
   * Parse inline style string to apply to element
   */
  function applyInlineStyles(element: HTMLElement, styleString: string): void {
    if (!styleString) return;

    const declarations = styleString.split(';').filter((s) => s.trim());
    declarations.forEach((declaration) => {
      const colonIndex = declaration.indexOf(':');
      if (colonIndex === -1) return;

      const property = declaration.slice(0, colonIndex).trim();
      const value = declaration.slice(colonIndex + 1).trim();

      if (!property || !value) return;

      element.style.setProperty(property, value);
    });
  }

  class CodeFullscreenController {
    private elements: CodeFullscreenElements;
    private unsubscribe: (() => void) | null = null;
    private currentData: CodeBlockData | null = null;
    private copyTimeoutId: ReturnType<typeof setTimeout> | null = null;

    constructor() {
      this.elements = this.initElements();
      if (this.validateElements()) {
        this.bindEvents();
        this.subscribeToStore();
        this.listenToCustomEvent();
      }
    }

    private initElements(): CodeFullscreenElements {
      return Object.entries(SELECTORS).reduce(
        (acc, [key, id]) => ({
          ...acc,
          [key]: document.getElementById(id),
        }),
        {} as CodeFullscreenElements,
      );
    }

    private validateElements(): boolean {
      return Object.entries(this.elements).every(([key, element]) => {
        const exists = !!element;
        if (!exists) {
          console.error(`代码全屏元素未找到: ${key}`);
        }
        return exists;
      });
    }

    private bindEvents(): void {
      document.addEventListener('keydown', this.handleKeyDown);
      this.elements.closeBtn?.addEventListener('click', this.handleClose);
      this.elements.dialog?.addEventListener('click', this.handleBackgroundClick);
      this.elements.copyBtn?.addEventListener('click', this.handleCopy);
    }

    private handleBackgroundClick = (e: MouseEvent): void => {
      // Only close if clicking the dialog background, not the content
      if (e.target === this.elements.dialog) {
        closeCodeFullscreen();
      }
    };

    private subscribeToStore(): void {
      this.unsubscribe = codeFullscreenData.subscribe((data) => {
        if (data) {
          this.currentData = data;
          this.open(data);
        } else {
          this.close();
        }
      });
    }

    /**
     * Listen to custom event from code block enhancer
     * Update store to keep state consistent
     */
    private listenToCustomEvent(): void {
      window.addEventListener('open-code-fullscreen', ((e: CustomEvent<CodeBlockData>) => {
        openCodeFullscreen(e.detail);
      }) as EventListener);
    }

    private handleKeyDown = (e: KeyboardEvent): void => {
      if (e.key === 'Escape' && codeFullscreenData.get()) {
        closeCodeFullscreen();
      }
    };

    private handleClose = (): void => {
      closeCodeFullscreen();
    };

    private handleCopy = async (): Promise<void> => {
      if (!this.currentData) return;

      const success = await copyToClipboard(this.currentData.code);
      if (success) {
        this.showCopiedState();
      }
    };

    private showCopiedState(): void {
      const { copyBtn, copyIcon, checkIcon, copyText } = this.elements;
      if (!copyBtn || !copyIcon || !checkIcon || !copyText) return;

      // Clear existing timeout
      if (this.copyTimeoutId) {
        clearTimeout(this.copyTimeoutId);
      }

      // Show checkmark
      copyIcon.classList.add(CLASSES.hidden);
      checkIcon.classList.remove(CLASSES.hidden);
      copyBtn.classList.add(CLASSES.copied);
      copyText.textContent = '已复制';

      // Reset after 2 seconds
      this.copyTimeoutId = setTimeout(() => {
        copyIcon.classList.remove(CLASSES.hidden);
        checkIcon.classList.add(CLASSES.hidden);
        copyBtn.classList.remove(CLASSES.copied);
        copyText.textContent = '复制';
        this.copyTimeoutId = null;
      }, 2000);
    }

    private open(data: CodeBlockData): void {
      const { overlay, dialog, content, language, pre, code } = this.elements;
      if (!overlay || !dialog || !content || !language || !pre || !code) return;

      // Set content
      language.textContent = data.language;
      pre.className = data.preClassName + ' p-4';
      pre.removeAttribute('style');
      applyInlineStyles(pre, data.preStyle);
      code.className = data.codeClassName;
      // SAFE: codeHTML comes from Shiki syntax highlighter output only
      code.innerHTML = data.codeHTML;

      // Show elements
      overlay.dataset.state = STATE.open;
      dialog.dataset.state = STATE.open;

      // Lock body scroll
      document.body.style.overflow = 'hidden';

      // Trigger animation
      requestAnimationFrame(() => {
        overlay.classList.remove(CLASSES.opacityZero);
        overlay.classList.add(CLASSES.opacityFull);
        content.classList.remove(CLASSES.opacityZero);
        content.classList.add(CLASSES.opacityFull);
      });
    }

    private close(): void {
      const { overlay, dialog, content } = this.elements;
      if (!overlay || !dialog || !content) return;

      // Trigger close animation
      overlay.classList.remove(CLASSES.opacityFull);
      overlay.classList.add(CLASSES.opacityZero);
      content.classList.remove(CLASSES.opacityFull);
      content.classList.add(CLASSES.opacityZero);

      // Hide elements after animation
      setTimeout(() => {
        overlay.dataset.state = STATE.closed;
        dialog.dataset.state = STATE.closed;
        document.body.style.overflow = '';
      }, 200);

      this.currentData = null;
    }

    public destroy(): void {
      document.removeEventListener('keydown', this.handleKeyDown);
      this.elements.closeBtn?.removeEventListener('click', this.handleClose);
      this.elements.dialog?.removeEventListener('click', this.handleBackgroundClick);
      this.elements.copyBtn?.removeEventListener('click', this.handleCopy);

      if (this.copyTimeoutId) {
        clearTimeout(this.copyTimeoutId);
      }

      if (this.unsubscribe) {
        this.unsubscribe();
        this.unsubscribe = null;
      }
    }
  }

  let controller: CodeFullscreenController | null = null;

  function init() {
    controller?.destroy();
    controller = new CodeFullscreenController();
  }

  // Initialize immediately if DOM is ready (handles race condition on first load)
  if (document.readyState !== 'loading') {
    init();
  }

  // Also listen for astro:page-load for subsequent navigations
  document.addEventListener('astro:page-load', init);

  // Close before page navigation
  document.addEventListener('astro:before-preparation', () => {
    closeCodeFullscreen();
  });
</script>
